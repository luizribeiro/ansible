- hosts: nuc
  vars:
    mailgun_password: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32353162333030343264633364623339643335343363303334666230356138393731646136666366
        3938616636666434666430616638623735373362323361320a633463616236383831626432666366
        61386363393231326439613233323938656166636131316232323362613934316432663838366165
        3034353331393233390a376664303231666561643930663734313464666535346431646432653430
        62306235666231346532316565326133353163653061646264323264323733396434623865636135
        37653230366161386338646465393835323536366536336663643464623965313862316337353632
        393434323038623538326366616261353839
  become: yes
  tasks:
    - name: Install Monit server
      pacman:
        name: monit
        state: latest
        update_cache: yes
      register: upgrade
    - name: Setup monitrc
      template:
        src: ./etc/monitrc
        dest: /etc/monitrc
        owner: root
        group: root
        mode: u+rw,g-rwx,o-rwx
      register: monitrc
    - name: Setup monitrc.d
      copy:
        src: ./etc/monitrc.d
        dest: /etc/monitrc.d
        owner: root
        group: root
        mode: u+rw,g-rwx,o-rwx
        directory_mode: u+rwx,g-rwx,o-rwx
      register: monitrc_d
    - name: Check monit config
      command: monit -t
      when: upgrade.changed or monitrc.changed or monitrc_d.changed
    - name: Enable monit
      systemd:
        name: monit
        enabled: yes
    - name: Restart monit
      systemd:
        name: monit
        state: restarted
      when: upgrade.changed or monitrc.changed or monitrc_d.changed
